services:
  certbot:
    image: certbot/dns-cloudflare:latest
    container_name: certbot
    restart: unless-stopped
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
      - ./nscacert.pem:/etc/ssl/certs/nscacert.pem:ro
    environment:
      - EMAIL=${CERTBOT_EMAIL}
      - DOMAINS=${CERTBOT_DOMAINS}
      - STAGING=${CERTBOT_STAGING:-false}
      - REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt
    entrypoint: ["/bin/sh", "-c"]
    command:
      - >-
        cat /etc/ssl/certs/nscacert.pem >> /etc/ssl/certs/ca-certificates.crt &&
        echo "dns_cloudflare_api_token = ${CLOUDFLARE_API_TOKEN}" > /etc/cloudflare.ini &&
        chmod 600 /etc/cloudflare.ini &&
        if [ ! -f /etc/letsencrypt/live/${PRIMARY_DOMAIN}/fullchain.pem ]; then
          echo 'Initial certificate request...' &&
          certbot certonly --dns-cloudflare --dns-cloudflare-credentials /etc/cloudflare.ini --dns-cloudflare-propagation-seconds 30 --agree-tos --no-eff-email --email ${CERTBOT_EMAIL} -d ${CERTBOT_DOMAINS} ${CERTBOT_STAGING:+--staging} &&
          echo 'Initial certificate obtained!';
        else
          echo 'Certificate exists, skipping initial request.';
        fi &&
        echo 'Setting up renewal cron...' &&
        echo '0 12 * * * /usr/bin/certbot renew --quiet --deploy-hook "echo Renewed!"' > /etc/crontabs/root &&
        crond -f
